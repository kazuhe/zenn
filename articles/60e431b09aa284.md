---
title: "Rust ã‚’ WebAssembly ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ Vite ã§ä½¿ã£ã¦ã¿ã‚‹"
emoji: "ğŸš²"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust", "webassembly", "vite"]
published: true
---

## ã¯ã˜ã‚ã«

2023 å¹´ 11 æœˆã‹ã‚‰å¼Šç¤¾ã§ [TRPL](https://doc.rust-jp.rs/book-ja/) ã®è¼ªèª­ä¼šã‚’é€±ä¸€ã§é–‹å‚¬ã—ã¦ã„ã¾ã™ã€‚ãã‚ãã‚ä½•ã‹ã‚’å‹•ã‹ã—ãŸã„è¡å‹•ã«é§†ã‚‰ã‚ŒãŸã®ã§ã€è‡ªåˆ†ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã§ Rust ã‹ã‚‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸ WebAssembly ã‚’ä½¿ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

ã¾ã ã€ŒRust ä½•ã‚‚åˆ†ã‹ã‚‰ã‚“ã€ãªç­†è€…ã§ã™ãŒã€ã¾ã‚‹ã§å®Ÿç”¨æ€§ã®ãªã„å¡Šã‚’ä½œã£ã¦ã¿ã¾ã™ã€‚

https://github.com/kazuhe/kazuhe.github.io/tree/050136bc43606d585068cae905313763c4f50bbd

ã¾ãŸã€ã“ã®è¨˜äº‹ã¯æ—¢ã« Vite ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ Rust ã‚’åˆ©ç”¨ã§ãã‚‹å‰æã§æ›¸ã„ã¦ã„ã¾ã™ã€‚

## Rust ã‹ã‚‰ WebAssembly ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

å®Ÿã¯ MDN ã«ã™ã”ãåˆ†ã‹ã‚Šã‚„ã™ã„ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/WebAssembly/Rust_to_Wasm

ãªã®ã§ MDN ã‚’è¦‹ã¦ãã ã•ã„ã€‚ä¸€å¿œã€é•·ã„æ–‡ç« ã‚’è¦‹ãŸããªã„äººã®ãŸã‚ã«ç°¡å˜ã«ã‚„ã£ãŸã“ã¨ã‚’æ›¸ãã¾ã™ã€‚

WebAssembly ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸã‚Šã€npm ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦å…¬é–‹ã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ãã‚Œã‚‹ [wasm-pack](https://github.com/rustwasm/wasm-pack) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
cargo install wasm-pack
```

æ¬¡ã« Rust ã®ã‚³ãƒ¼ãƒ‰ã‚’ç½®ããƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
mkdir packages
```

ç§»å‹•ã—ã¦ cargo new ã‚’ã—ã¾ã™ã€‚

```bash
cargo new --lib wasm-kazuhe-github-io
```

`Cargo.toml` ã¨ `src/lib.rs` ãŒä½œæˆã•ã‚Œã‚‹ã®ã§ã€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«å¾“ã£ã¦ JavaScript ã‹ã‚‰ `window.alert` ã‚’å—ã‘å–ã‚Šã€greet é–¢æ•°ã®ä¸­ã§å®Ÿè¡Œã™ã‚‹ã ã‘ã®æ¥µã‚ã¦å˜ç´”ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚

```rust:/packages/src/lib.rs
use wasm_bindgen::prelude::*;

#[wasm_bindgen]
extern "C" {
    pub fn alert(s: &str);
}

#[wasm_bindgen]
pub fn greet(name: &str) {
    alert(&format!("Hello, {}!", name));
}
```

wasm-bindgen ã®ä¾å­˜ã®è¿½åŠ ã¨ãã®ä»–è¨­å®šã‚’ `Cargo.toml` ã«è¿½è¨˜ã—ã¾ã™ã€‚

```toml:Cargo.toml
[package]
name = "wasm-kazuhe-github-io"
version = "0.1.0"
authors = ["Ohara Kazuhiro"]
description = "WebAssembly package for my website."
repository = "https://github.com/kazuhe/kazuhe.github.io"
edition = "2021"

[lib]
crate-type = ["cdylib"]

[dependencies]
wasm-bindgen = "0.2.84"
```

npm ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦å…¬é–‹ã™ã‚‹ãŸã‚ã« wasm-pack ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
wasm-pack build packages --target bundler
```

ã“ã‚Œã§ `packages/pkg` ã« `package.json` ã‚„ `.wasm` ãƒ•ã‚¡ã‚¤ãƒ«ã€å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ« (`.d.ts`) ãŒç”Ÿæˆã•ã‚Œã€WebAssembly ã® npm ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã§ãã¾ã—ãŸã€‚

## WebAssembly ã® npm ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…¬é–‹

npm ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå¿…è¦ãªã®ã§ã€ãªã‘ã‚Œã°ä½œæˆã—ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚ãã®å¾Œ publish ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§ç°¡å˜ã«å…¬é–‹ãŒã§ãã¾ã™ã€‚

(ç§ä»¥å¤–ä½¿ã‚ãªã„ã®ã«ã€ã‚ã–ã‚ã– npm ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦å…¬é–‹ã™ã‚‹ã®ã‚‚å¤§è¢ˆè£Ÿã§ã™ãŒç·´ç¿’ã¨ã—ã¦å…¬é–‹ã—ã¦ã¿ã¾ã—ãŸ)

```bash
wasm-pack login
wasm-pack publish
```

https://www.npmjs.com/package/wasm-kazuhe-github-io

ã“ã‚Œã§ npm ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†æº–å‚™ãŒã§ãã¾ã—ãŸã€‚

## Vite ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã®åˆ©ç”¨

æ™®é€šã® npm ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ã¨åŒã˜ã‚ˆã†ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
pnpm i -E wasm-kazuhe-github-io
```

Rust ã§å®šç¾©ã—ãŸ greet é–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

```ts:/src/index.ts
import { greet } from "wasm-kazuhe-github-io";

greet("wasm");
```

ç”Ÿæˆã•ã‚ŒãŸ npm ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å«ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€ã‚‚ã¡ã‚ã‚“å‹ã®è£œå®Œã‚‚åŠ¹ãã¾ã™ã€‚

![ã‚¨ãƒ‡ã‚£ã‚¿](https://storage.googleapis.com/zenn-user-upload/caa4ded4a052-20231204.png)

`index.html` ã« TypeScript ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚

```html:index.html
<body>
  <!-- ~~ -->
  <script type="module" src="/src/index.ts"></script>
</body>
```

ç¾æ™‚ç‚¹ã§ã¯ã€ã“ã®ã¾ã¾ã®çŠ¶æ…‹ã ã¨ WebAssembly ãŒ ESM ã¨çµ±åˆã•ã‚Œã¦ã„ãªã„ãŸã‚å‹•ä½œã—ã¾ã›ã‚“ã€‚ãŸã ã€ESM çµ±åˆã®ææ¡ˆãŒã‚ã‚Šã€å°†æ¥çš„ã«ã¯å‹•ä½œã™ã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

https://github.com/WebAssembly/esm-integration/tree/main/proposals/esm-integration

ãªã®ã§ã€[vite-plugin-wasm](https://github.com/Menci/vite-plugin-wasm) ã‚’è¿½åŠ ã—ã¾ã™ã€‚

ã¾ã  top-level await ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ–ãƒ©ã‚¦ã‚¶ã‚‚ã‚ã‚‹ã‚ˆã†ãªã®ã§ã€ã¤ã„ã§ã« [vite-plugin-top-level-await](https://github.com/Menci/vite-plugin-top-level-await) ã‚‚è¿½åŠ ã—ã¾ã™ã€‚

https://v8.dev/features/top-level-await#support

![v8.dev](https://storage.googleapis.com/zenn-user-upload/e3337a3945e1-20231204.png)

`vite.config.ts` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚

```ts:vite.config.ts
import { defineConfig } from "vite";
import wasm from "vite-plugin-wasm";
import topLevelAwait from "vite-plugin-top-level-await";

export default defineConfig({
  plugins: [wasm(), topLevelAwait()],
});
```

ã“ã‚Œã‚’ GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã‚‹ã¨..

![kazuhe.github.io](https://storage.googleapis.com/zenn-user-upload/1f94241c1865-20231204.png)

`.wasm` ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ `window.alert` ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

## ã•ã„ã”ã«

~~ä»Šã®çŠ¶æ…‹ã§ã¯ã€ã¾ã‚‹ã§å®Ÿç”¨æ€§ã®ãªã„æ©Ÿèƒ½ã§ã™ãŒ~~ ç°¡å˜ã« WebAssembly ã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
